#!/usr/bin/env ruby
require 'fileutils'

COMMANDS = %w[console logs status spec].freeze

# Check if first argument is a command (default to production) or environment flag
if COMMANDS.include?(ARGV[0])
  # First argument is a command, default to production environment
  env = '-p'
  command = ARGV[0]
  optional_args = ARGV[1..]&.join(' ')
else
  # First argument is environment flag
  env = ARGV[0]
  command = ARGV[1]
  optional_args = ARGV[2..]&.join(' ')
end

unless COMMANDS.include?(command)
  puts "Usage: digital [-s|-p] #{COMMANDS.join('|')} [--optional-args]"
  puts 'Environment defaults to production (-p) if not specified'
  exit 1
end

require 'dotenv'
Dotenv.load('.env.digital')

# Define constants for environment variable keys
ENVIRONMENTS = {
  '-p' => {
    app_id: 'PRODUCTION_APP_ID',
    web_name: 'PRODUCTION_WEB_NAME',
    label: 'PRODUCTION'
  },
  '-pre' => {
    app_id: 'PRE_PROD_APP_ID',
    web_name: 'PRE_PROD_WEB_NAME',
    label: 'PRE_PROD'
  },
  '-s' => {
    app_id: 'STAGING_APP_ID',
    web_name: 'STAGING_WEB_NAME',
    label: 'STAGING'
  }
}.freeze

  # Extract environment variables based on selected environment
  if ENVIRONMENTS[env]
    env_details = ENVIRONMENTS[env]
    app_id = ENV[env_details[:app_id]]
    web_name = ENV[env_details[:web_name]]
    label = env_details[:label]
  else
    env_var_prefix = env.gsub(/^-+/, '').upcase
    app_id = ENV["#{env_var_prefix.upcase}_APP_ID"]
    web_name = ENV["#{env_var_prefix.upcase}_WEB_NAME"]
    label = env_var_prefix.upcase
  end

# Ensure necessary environment variables are set
unless app_id && web_name
  if ENVIRONMENTS[env]
    app_id_key = ENVIRONMENTS[env][:app_id]
    web_name_key = ENVIRONMENTS[env][:web_name]
  else
    app_id_key = "#{env_var_prefix}_APP_ID"
    web_name_key = "#{env_var_prefix}_WEB_NAME"
  end

  puts "Missing environment variables for #{label}."
  puts "Please define #{app_id_key} and #{web_name_key} in .env.digital"
  exit 1
end

# Display environment label
puts '======================='
puts "=======#{label}======="
puts '======================='

# Command mode logic based on additional flags
case command
when 'logs'
  command = ['doctl', 'apps', 'logs', app_id, web_name, optional_args].join(' ')
when 'status'
  command = [
    'doctl', 'apps', 'list-deployments', app_id, web_name,
    '--format', 'Created,Updated,Cause,Phase', '|', 'head', '-5'
  ].join(' ')
when 'console'
  command = ['doctl', 'apps', 'console', app_id, web_name].join(' ')
when 'spec'
  command = ['doctl', 'apps', 'spec', app_id.join(' ')
end

# Execute the constructed command
system(command)
